name: Trigger Registry CI

on:
  push:
    paths:
      - 'src/control/**'
      - 'scripts/migrate-trigger-registry.js'
      - 'database/migrations/**'
      - 'data/triggerRegistry.json'
  pull_request:
    paths:
      - 'src/control/**'
      - 'scripts/migrate-trigger-registry.js'
      - 'database/migrations/**'

jobs:
  dry-run:
    name: Migration Dry-Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run migration dry-run
        run: npm run migrate:dry

  integration:
    name: Integration (Postgres)
    runs-on: ubuntu-latest
    needs: dry-run
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user -d testdb"
          --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Wait for Postgres
        run: |
          until pg_isready -h localhost -p 5432 -U user -d testdb; do sleep 1; done
      - name: Install dependencies
        run: npm ci
      - name: Apply SQL migrations
        env:
          DB_CONN: postgres://user:password@localhost:5432/testdb
        run: npm run migrate:sql
      - name: Verify trigger_registry table
        env:
          DB_CONN: postgres://user:password@localhost:5432/testdb
        run: |
          psql "$DB_CONN" -c "SELECT to_regclass('public.trigger_registry') as table_exists;"
      - name: Run integration + unit tests (Vitest)
        env:
          DB_CONN: postgres://user:password@localhost:5432/testdb
        run: |
          npm run test:unit || true
          npm run test:integration || true

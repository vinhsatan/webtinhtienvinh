name: Automation Safety

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  safety:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run policy check
        run: |
          npm run tooling:policy-check || true

      - name: Upload policy artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-check-result
          path: policy-check-result.json

      - name: Run simulation harness
        run: |
          npm run test:simulation || true

      - name: Run error-flow (diagnostics)
        run: |
          npm run error-flow || true

      - name: Upload simulation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-report
          path: simulation/report.json

      - name: Upload error-flow report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-flow-report
          path: simulation/error-flow-report.json
name: Automation Safety CI

on:
  pull_request:
    paths:
      - 'src/orchestrator/**'
      - 'src/**reconciler/**'
      - 'production_master_blueprint.mb'

jobs:
  simulation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          npm ci
      - name: Lockfile check
        run: |
          node scripts/ci-fix-lockfile.cjs
        continue-on-error: false
      - name: Run Simulation Suite
        run: |
          # run simulation tests (must output signed report)
          npm run test:simulation
      - name: Upload Simulation Report
        uses: actions/upload-artifact@v4
        with:
          name: simulation-report
          path: ./simulation/report.json

  policy-checks:
    needs: simulation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run PDP checks
        run: |
          npm run tooling:policy-check

      - name: Upload policy-check result
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: policy-check
          path: ./policy-check-result.json

  approvals-and-canary:
    needs: policy-checks
    runs-on: ubuntu-latest
    environment:
      name: staging
      deployment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Canary
        run: |
          npm run deploy:canary
      - name: Wait and Monitor
        run: |
          npm run monitor:canary -- --timeout=300
      - name: Require Manual Approval
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: require-approval

  repair-lockfile:
    name: Repair lockfile (auto-PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Check lockfile
        id: lockcheck
        run: |
          node scripts/ci-fix-lockfile.cjs || echo "LOCK_MISMATCH=1" > lockflag
      - name: Regenerate package-lock (if mismatch)
        if: always()
        run: |
          if [ -f lockflag ]; then
            npm install --package-lock-only
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "chore(ci): regenerate package-lock.json [ci skip]" || echo "no changes to commit"
          else
            echo "No lockfile mismatch detected"
          fi
      - name: Create fix PR
        if: always()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: chore(ci): regenerate package-lock.json
          branch: lockfile-fix/${{ github.head_ref }}
          title: "fix: regenerate package-lock.json"
          body: |
            This PR was automatically generated by the automation safety CI job to regenerate `package-lock.json` when a mismatch was detected.
          labels: automated, ci
